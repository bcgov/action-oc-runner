name: OpenShift CLI (oc) Login and Runner
description: Action for running oc commands
branding:
  icon: package
  color: blue

inputs:
  ### Required
  oc_namespace:
    description: OpenShift namespace; e.g. abc123-dev
    required: true
    pattern: '^[a-z0-9]{6}-(dev|test|prod|tools)$'
  oc_server:
    description: OpenShift server; e.g. https://api.silver.devops.gov.bc.ca:6443
    required: true
    pattern: '^https:\/\/.*:6443$'
  oc_token:
    description: OpenShift access token
    required: true
    minLength: 32

  ### Typical / recommended
  commands:
    description: Command to run, generally oc commands; e.g. oc whoami
  cronjob:
    description: Cronjob to run, watch and report on
  triggers:
    description: Bash array to diff for triggering, omit to always run; e.g. ('./backend/' './frontend/)

  ### Usually a bad idea / not recommended
  cronjob_tail:
    description: Number of cronjob log lines to tail; use -1 for all
    default: -1
  diff_branch:
    description: Branch to diff against
    default: ${{ github.event.repository.default_branch }}
  oc_version:
    description: Override oc version, >= 4.0; e.g. 4.14
    default: ''
    pattern: '^4\.[0-9]+$'
  repository:
    description: Optionally, specify a different repo to clone
    default: ${{ github.repository }}
  timeout:
    description: Timeout for commands or cronjob; e.g. 10m
    default: 10m
    pattern: '^[0-9]+[mhs]$'

outputs:
  triggered:
    description: Whether the action was triggered
    value: ${{ steps.diff.outputs.triggered }}

permissions: {}

runs:
  using: composite
  steps:
    # Send triggers to diff action
    - id: diff
      uses: bcgov/action-diff-triggers@v0.2.0
      with:
        triggers: ${{ inputs.triggers }}
        diff_branch: ${{ inputs.diff_branch }}

    - if: steps.diff.outputs.triggered == 'true'
      env:
        OC: ${{ inputs.oc_version || '4.14' }}
      shell: bash
      working-directory: /usr/local/bin
      run: |
        # Install CLI Tool and Login
        if ! command -v oc &> /dev/null; then
          URL="https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable-${OC}/openshift-client-linux.tar.gz"
          (wget "${URL}" -qcO - | tar -xzvf - oc) || !! || { echo "Failed to download oc client"; exit 1; }
        fi

        # OpenShift login
        oc login --server=${{ inputs.oc_server }} --token=$( curl -ksX POST \
          ${{ inputs.oc_server }}/api/v1/namespaces/${{ inputs.oc_namespace }}/serviceaccounts/pipeline/token \
          --header "Authorization: Bearer ${{ inputs.oc_token }}" \
          --header "Content-Type: application/json; charset=utf-8" \
          --data '{"spec": {"expirationSeconds": 600}}' \
          | jq -r '.status.token' \
        ) || { echo "Failed to obtain service account token"; exit 1; }

        # Verify namespace
        if [ "$( oc project -q )" != "${{ inputs.oc_namespace }}" ]; then
          echo "Project and token do not match!"
          exit 1
        fi

    - if: steps.diff.outputs.triggered == 'true'
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.repository }}

    - if: steps.diff.outputs.triggered == 'true' && inputs.commands
      shell: bash
      run: |
        # Run command(s)
        ${{ inputs.commands }}

    - if: steps.diff.outputs.triggered == 'true' && inputs.cronjob
      shell: bash
      run: |
        # Cronjob => job
        JOB_NAME=${{ inputs.cronjob }}--$(date +"%Y-%m-%d--%H-%M-%S")
        oc create job ${JOB_NAME} --from=cronjob/${{ inputs.cronjob }}

        # Wait for status=ready|completed - oc wait fails for overly quick jobs
        timeout ${{ inputs.timeout }} bash -c "
        while true; do
          oc get pods -l job-name=${RUN_JOB} --no-headers | awk '{print $3}' | grep -i 'running\|completed' && break
          sleep 3
        done" || { echo "Timeout waiting for job to start"; exit 1; }

        # Follow
        # Follow logs
        oc logs -l job-name=${RUN_JOB} --follow --tail=${{ inputs.cronjob_tail }}

        # Results
        echo "JOB_NAME=${JOB_NAME}" >> $GITHUB_ENV
        echo "Job successful!"

    # Action repo needs to be present for cleanup/tests
    - if: steps.diff.outputs.triggered == 'true' && github.repository != inputs.repository
      name: Checkout local repo to make sure action.yml is present
      uses: actions/checkout@v4
